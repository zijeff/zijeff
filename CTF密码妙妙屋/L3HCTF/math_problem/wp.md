# L3HCTF2025 Crypto方向 math_problem

***by zijeff***

```python
def myfunction(num):
    output = 0
    output=num**3
    return output
```

首先题目给出的这个函数就是算一个输入数的三次方。

```python
if __name__ == '__main__':
    flag_len = len(flag)
    p, q = getPrime(512), getPrime(512)

    while True:
        r = getPrime(512)
        R = bytes_to_long(str(r).encode())
        if isPrime(R):
            break

    n = p * q * r
    hint1 = R * r
    mod = myfunction(n)
    hint2 = pow(3*n+1, p % (2 ** 400), mod)
    m = bytes_to_long(flag)
    c = pow(m, 65537, n)
```

接下来这段代码就是对flag加密的流程了，首先是正常的选取p和q，然后是生成了R和r，R是依赖于r所决定的。最后题目给出了n，c，hint1，hint2.

我们接下来就把已知条件全部用数学表达式列出来，具体分析一下。

首先，r是十分容易求解的，因为r就是n与hint1的公因数。
$$
r = gcd(n, hint_1)
$$
好的，那么hint1作为条件已经被我们使用完了，接下来就是处理hint2了。

接下来，我们不妨设
$$
k = p \mod 2^{400}
$$

$$
hint_2 = (3n+1)^k \mod n^3
$$

那我们尝试对等式右边做二项式展开，那么所有次数大于3的含n项都会被模数给模掉，那么就变成了如下等式。
$$
hint_2 = 1+3kn+\frac{k(k-1)}{2}(3n)^2 \mod n^3
$$
根据同余的基本性质，显然对等式作变形
$$
\frac{hint_2-1}{n}\equiv 3k+\frac{9k(k-1)}{2}n \mod n^2
$$
我们不妨令
$$
A = \frac{hint_2-1}{n}
$$
则有
$$
A \equiv 3k +\frac{9k(k-1)}{2}n \mod n^2
$$
根据同余的性质，我们可以得到
$$
A = 3k +\frac{9k(k-1)}{2}n + Cn^2
$$
其中C为一整数，那么我们对等式左右两边同时模n就会得到
$$
A \equiv 3k \mod n
$$
那么k也就可以计算得到了
$$
k \equiv 3^{-1}A \mod n
$$
最后再回到k的生成过程来，k实际上是p的低位信息，那么根据Coppersmith攻击就可以有效地恢复出来p的所有信息。什么是Coppersmith攻击呢？我也不太懂，感兴趣的可以自己去查询相关资料，等我搞明白了会再给出完整证明论述。

一旦我恢复出了p，所有问题即可迎刃而解。

```python
from sage.all import *
from Crypto.Util.number import *
n = 1031361339208727791691298627543660626410606240120564103678654539403400080866317968868129842196968695881908504164493307869679126969820723174066217814377008485456923379924853652121682069359767219423414060835725846413022799109637665041081215491777412523849107017649039242068964400703052356256244423474207673552341406331476528847104738461329766566162770505123490007005634713729116037657261941371410447717090137275138353217951485412890440960756321099770208574858093921
c = 102236458296005878146044806702966879940747405722298512433320216536239393890381990624291341014929382445849345903174490221598574856359809965659167404530660264493014761156245994411400111564065685663103513911577275735398329066710295262831185375333970116921093419001584290401132157702732101670324984662104398372071827999099732380917953008348751083912048254277463410132465011554297806390512318512896160903564287060978724650580695287391837481366347198300815022619675984
hint1 = 41699797470148528118065605288197366862071963783170462567646805693192170424753713903885385414542846725515351517470807154959539734665451498128021839987009088359453952505767502787767811244460427708303466073939179073677508236152266192609771866449943129677399293427414429298810647511172104050713783858789512441818844085646242722591714271359623474775510189704720357600842458800685062043578453094042903696357669390327924676743287819794284636630926065882392099206000580093201362555407712118431477329843371699667742798025599077898845333
hint2 = 10565371682545827068628214330168936678432017129758459192768614958768416450293677581352009816968059122180962364167183380897064080110800683719854438826424680653506645748730410281261164772551926020079613841220031841169753076600288062149920421974462095373140575810644453412962829711044354434460214948130078789634468559296648856777594230611436313326135647906667484971720387096683685835063221395189609633921668472719627163647225857737284122295085955645299384331967103814148801560724293703790396208078532008033853743619829338796313296528242521122038216263850878753284443416054923259279068894310509509537975210875344702115518307484576582043341455081343814378133782821979252975223992920160189207341869819491668768770230707076868854748648405256689895041414944466320313193195829115278252603228975429163616907186455903997049788262936239949070310119041141829846270634673190618136793047062531806082102640644325030011059428082270352824026797462398349982925951981419189268790800571889709446027925165953065407940787203142846496246938799390975110032101769845148364390897424165932568423505644878118670783346937251004620653142783361686327652304482423795489977844150385264586056799848907
r = gcd(n, hint1)
print(r)
N = n//r
tmp = (hint2 - 1)//n
p_low = (tmp*inverse(3, n)) % n
print(p_low)
PR.<x> = PolynomialRing(Zmod(N), implementation='NTL')
f = p_low + x*(2**400)
x0 = f.monic().small_roots(X = 2^128, beta = 0.1)[0]
p = int(f(x0))
print(p)
q = N//p
print(q)
phi = (p-1)*(q-1)*(r-1)
d = inverse(65537, phi)
m = pow(c, d, n)
flag = long_to_bytes(int(m))
print(flag)
```

最后得到flag：***L3HCTF{1s_4h1s_r3a11y_m4th?}***